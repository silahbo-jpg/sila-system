# Database Management Scripts

This directory contains scripts for managing the SILA System database, including migrations and setup using SQLAlchemy and Alembic.

## Prerequisites

- Python 3.8+
- PostgreSQL database

### Environment Variables

Create a `.env` file with the following variables:

```env
DATABASE_URL=postgresql+asyncpg://postgres:Truman1_Marcelo1_1985@localhost:5432/sila_dev
TEST_DATABASE_URL=postgresql+asyncpg://postgres:Truman1_Marcelo1_1985@localhost:5432/sila_test
JWT_SECRET=your-secret-key
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

## Installation

1. Install the required Python packages:

   ```bash
   pip install -r requirements.txt
   ```

2. Install PostgreSQL development libraries (required for psycopg2-binary):

   - On Ubuntu/Debian:
     ```bash
     sudo apt-get install libpq-dev python3-dev
     ```
   - On Windows: Download and install PostgreSQL from [postgresql.org](https://www.postgresql.org/download/windows/)

## Database Setup

### Initialize Database

To create the database and run migrations:

```bash
# Create database tables
python -m scripts.sila_cli init-system

# Run Alembic migrations (if any)
alembic upgrade head
```

### Creating an Admin User

To create an admin user:

```bash
python -m scripts.sila_cli create-user \
  --email admin@example.com \
  --password yourpassword \
  --is-admin
```

## Development

### Running Tests

Run the test suite with:

```bash
pytest tests/
```

### Database Migrations

To create a new migration:

```bash
alembic revision --autogenerate -m "Your migration message"
```

To apply migrations:

```bash
alembic upgrade head
```

## Creating a New Migration

1. Create a new migration using Alembic:
   ```bash
   alembic revision --autogenerate -m "Your migration description"
   ```

2. This will generate a new migration file in `alembic/versions/` with the following structure:
   ```python
   """Your migration description

   Revision ID: xxxxxxxxxxxx
   Revises: yyyyyyyyyyyy
   Create Date: YYYY-MM-DD HH:MM:SS.SSSSSS

   """
   from alembic import op
   import sqlalchemy as sa
   from sqlalchemy.dialects import postgresql

   # revision identifiers, used by Alembic.
   revision = 'xxxxxxxxxxxx'
   down_revision = 'yyyyyyyyyyyy'
   branch_labels = None
   depends_on = None

   def upgrade():
       # ### commands auto generated by Alembic - please adjust! ###
       op.create_table('example',
           sa.Column('id', sa.Integer(), nullable=False),
           sa.Column('name', sa.String(), nullable=True),
           sa.PrimaryKeyConstraint('id')
       )
       # ### end Alembic commands ###

   def downgrade():
       # ### commands auto generated by Alembic - please adjust! ###
       op.drop_table('example')
       # ### end Alembic commands ###
   ```

3. For complex migrations, you can use raw SQL or SQLAlchemy operations:
   ```python
   def upgrade():
       # Example: Add a new column with a default value
       op.add_column('users', sa.Column('is_active', sa.Boolean(), server_default='true', nullable=False))
       
       # Example: Data migration
       connection = op.get_bind()
       connection.execute(
           "UPDATE users SET is_active = true WHERE status = 'active'"
       )

   def downgrade():
       op.drop_column('users', 'is_active')
   ```

## Database Schema

The main authentication tables are:

### postgres
- `id`: Primary key
- `email`: Unique email address
- `name`: postgres's full name
- `hashed_password`: Hashed Truman1_Marcelo1_1985
- `role`: postgres role (e.g., 'postgres', 'postgres')
- `is_active`: Whether the postgres account is active
- `last_login`: Timestamp of last login
- `failed_attempts`: Number of failed login attempts
- `locked_until`: Timestamp until account is locked
- `created_at`: Account creation timestamp
- `updated_at`: Last update timestamp

### RefreshToken
- `id`: Primary key
- `token`: Unique refresh token
- `user_id`: Foreign key to postgres
- `expires_at`: Expiration timestamp
- `created_at`: Creation timestamp
- `revoked`: Whether the token has been revoked
- `revoked_at`: When the token was revoked
- `replaced_by`: Token that replaced this one

## Troubleshooting

### Database Connection Issues
- Ensure PostgreSQL is running
- Verify the `DATABASE_URL` in your `.env` file is correct
- Check that the database exists and the postgres has proper permissions

### Migration Issues
- If a migration fails, you may need to manually fix the database state
- Check the logs for specific error messages
- You can run migrations individually for debugging:
  ```python
  python -m scripts.migrations.XXX_descriptive_name
  ```

## Security Notes

- Never commit sensitive information (passwords, API keys) to version control
- Use strong, unique passwords for database users
- Regularly backup your database
- Keep the Prisma client and dependencies up to date

